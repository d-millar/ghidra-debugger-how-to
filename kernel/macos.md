# macos kernel

## Context
- OS: macos x64 with VMware
- debugger: lldb
- target: Sequoia

## Set-up

- Recommended reading: **Debugging macOS Kernel using Virtual Box** (https://klue.github.io/blog/2017/04/macos_kernel_debugging_vbox/)
- Also: **How to Convert a MacOS Installer to ISO** (https://osxdaily.com/2020/07/20/how-convert-macos-installer-iso)
- Also: **Install macOS does not appear to be a valid OS installer application** (https://apple.stackexchange.com/questions/439402/install-macos-monterey-app-does-not-appear-to-be-a-valid-os-installer-applicatio)
- Also: **MacOS Two-machine Kernel Debugging** (https://diverto.github.io/2022/03/06/macos-two-Machine-kernel-debugging)

### Creating a macos VM
- From terminal:
```
softwareupdate --list-full-installers
softwareupdate --fetch-full-installer --full-installer-version 15.1
hdiutil create -o /tmp/Sequoia -size 20000m -volname Sequoia -layout SPUD -fs HFS+J
hdiutil attach /tmp/Sequoia.dmg -noverify -mountpoint /Volumes/Sequoia
sudo /Applications/Install\ macOS\ Sequoia.app/Contents/Resources/createinstallmedia --volume /Volumes/Sequoia --nointeraction
hdiutil detach /Volumes/Install\ macOS\ Sequoia
hdiutil convert /tmp/Sequoia.dmg -format UDTO -o ~/Desktop/Sequoia.cdr
mv ~/Desktop/Sequoia.cdr ~/Desktop/Sequoia.iso
```
- In VMware Fusion, create the new VM in the usual fashion.

### Loading a development version of the kernel
- On both the target and the host, download the desired KDK.
- With the ISO still mounted, `Power On To Firmware` to get into Recovery mode
- On boot, select `Utilities->Terminal`
- in the terminal:
```
csrutil disable
csrutil authenticated-root disable
reboot
```
- From a terminal post-reboot:
```
mkdir ~/rootmount
sudo mount -o nobrowse -t aps /dev/disk1s5 ~/rootmount (assuing /dev/disk1s5s1 is (apfs, sealed, local, read-only, journaled)
sudo ditto /Library/Developer/KDKs/<KDK Version>/System ~/rootmount/System
sudo kmutil install -R ~/rootmount -u
sudo bless --mount ~/rootmount -bootefi -create-snapshot
sudo nvram boot-args="debug=0x44 kdp_match_name=en0 wdt=-1 kcsuffix=development
sudo reboot
```
- On reboot, validate using `sysctl kern.osbuildconfig`  (should return `development`)

### Generating an NMI
- From a terminal:
```
cd ~/Virtual\ Machines.localized/macOS\ 15.vmwarevm (or wherever your VM is stored)
perl -i -pe 's/(?<=pendingNMI\x00{4})\x00/\x01/' macOS\ 15-5139bd76.vmss
```

### Starting the debugger

- From the Ghidra toolbar, `Configure and launch kernel.development using...->kernel-lldb`.
```
Host: <target's IP>
Architecture: <empty>
lldb command: lldb
```
- `Launch`

## Terminal Output:

```
(lldb) version
lldb-1600.0.39.109
Apple Swift version 6.0.3 (swiftlang-6.0.3.1.10 clang-1600.0.30.1)
(lldb) script import ghidralldb
(lldb) kdp-remote 172.16.180.132
Version: Darwin Kernel Version 24.1.0: Thu Oct 10 21:24:29 PDT 2024; root:xnu_development-11215.41.3~3/DEVELOPMENT_X86_64; 
UUID=744F785C-7CC8-326B-AE7B-82C4B2
C70606; stext=0xffffff801e2fc000
Kernel UUID: 744F785C-7CC8-326B-AE7B-82C4B2C70606
Load Address: 0xffffff801e2fc000
WARNING: Unable to locate kernel binary on the debugger system.
(lldb) ghidra trace connect "127.0.0.1:56860"
Process 1 stopped
* thread #1, stop reason = signal SIGSTOP
    frame #0: 0xffffff801e6415f5
->  0xffffff801e6415f5: pushfq 
    0xffffff801e6415f6: popq   %rax
    0xffffff801e6415f7: testl  $0x200, %eax   ; imm = 0x200 
    0xffffff801e6415fc: jne    0xffffff801e641742
Target 0: (No executable module.) stopped.
(lldb) ghidra trace start
(lldb) ghidra trace sync-enable
(lldb) ghidra trace sync-synth-stopped
add initial events for cli failed
add initial events for target failed
add initial events for process failed
```

## Notes:
- Be warned: this is pretty hard to get right.  
- Recommend you snapshort the VM after creating it and, again, after loading the dev kernel
- NMI can also be generated by flipping the low bit on the boot-args `debug` param, but the target is then dead-in-the-water.

